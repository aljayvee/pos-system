const y=document.getElementById("cashier-config"),u={pointsValue:Number(y?.dataset.pointsValue||1),loyaltyEnabled:Number(y?.dataset.loyaltyEnabled||0),paymongoEnabled:Number(y?.dataset.paymongoEnabled||0),birEnabled:Number(y?.dataset.birEnabled||0),taxType:y?.dataset.taxType||"inclusive",csrfToken:document.querySelector('meta[name="csrf-token"]')?.getAttribute("content"),userRole:y?.dataset.userRole||"cashier",registerLogsEnabled:y?.dataset.registerLogs||"0",isRegisterOpen:y?.dataset.registerOpen==="1"};let l=JSON.parse(localStorage.getItem("pos_cart"))||[],m={id:"walk-in"},p={type:"na",name:"",card_no:"",amount:0},g=null,h=!navigator.onLine,v=!1,w="",I=null,B=!1;const b=window.ALL_PRODUCTS||[];window.playSuccessBeep=function(){const e=new(window.AudioContext||window.webkitAudioContext),t=e.createOscillator(),n=e.createGain();t.connect(n),n.connect(e.destination),t.type="square",t.frequency.value=1500,n.gain.value=.1,t.start(),t.stop(e.currentTime+.1)};const T=new Audio("https://actions.google.com/sounds/v1/alarms/spaceship_alarm.ogg");window.toggleViewMode=function(){const e=document.getElementById("product-list-container"),n=document.getElementById("view-toggle-btn")?.querySelector("i");e.classList.contains("list-view-mode")?(e.classList.remove("list-view-mode"),n?.classList.remove("fa-th-large"),n?.classList.add("fa-list"),localStorage.setItem("cashier_view_mode","grid")):(e.classList.add("list-view-mode"),n?.classList.remove("fa-list"),n?.classList.add("fa-th-large"),localStorage.setItem("cashier_view_mode","list"))};document.addEventListener("DOMContentLoaded",()=>{if(localStorage.getItem("cashier_view_mode")==="list"){document.getElementById("product-list-container")?.classList.add("list-view-mode");const t=document.getElementById("view-toggle-btn");t&&(t.querySelector("i").classList.remove("fa-list"),t.querySelector("i").classList.add("fa-th-large"))}});const C={MultiBuy:(e,t,n)=>{if(!n||n.length===0)return e*t;const o=[...n].sort((s,r)=>r.quantity-s.quantity);let a=t,i=0;for(const s of o)if(a>=s.quantity){const r=Math.floor(a/s.quantity);i+=r*parseFloat(s.price),a%=s.quantity}return a>0&&(i+=a*e),i}};window.addToCart=function(e){let t=e;if(typeof e!="object"){if(t=b.find(o=>o.id==e),!t){console.error("AddToCart: Product not found via ID",e);return}}else if(e.id){const o=b.find(a=>a.id===e.id);o&&(t=o)}const n=l.find(o=>o.id===t.id);if(n)if(n.qty<t.current_stock)n.qty++;else{T.play(),Swal.fire({toast:!0,icon:"warning",title:"Max Stock Reached",position:"top-end",showConfirmButton:!1,timer:1500});return}else if(t.current_stock>0||parseFloat(t.current_stock)>0)l.push({...t,qty:1,max:t.current_stock});else{T.play(),Swal.fire({toast:!0,icon:"error",title:"Out of Stock",position:"top-end",showConfirmButton:!1,timer:1500});return}f()};window.modifyQty=function(e,t){const n=l[e],o=n.qty+t;o<=0?l.splice(e,1):o<=n.max&&(n.qty=o),f()};window.removeItem=function(e){l.splice(e,1),f()};window.clearCart=function(){l.length!==0&&Swal.fire({title:"Clear Cart?",icon:"warning",showCancelButton:!0,confirmButtonColor:"#d33",confirmButtonText:"Yes"}).then(e=>{e.isConfirmed&&(l=[],f())})};window.overridePrice=function(e){const t=l[e];Swal.fire({title:"Override Price",text:`Set new price for ${t.name}`,input:"number",inputValue:t.price,showCancelButton:!0,confirmButtonText:"Update"}).then(n=>{if(n.isConfirmed){const o=parseFloat(n.value);o>=0?(t.price=o,t.is_overridden=!0,f()):Swal.fire("Invalid Price","Price cannot be negative.","error")}})};window.openDiscountModal=function(){new bootstrap.Modal(document.getElementById("discountModal")).show()};window.applyDiscount=function(){const e=document.querySelector('input[name="discount_type"]:checked').value,t=document.getElementById("discount-name").value.trim(),n=document.getElementById("discount-id").value.trim();if(!t||!n){Swal.fire("Error","Cardholder Name and ID Number are required.","error");return}p={type:e,name:t,card_no:n,amount:0};const o=document.getElementById("discountModal"),a=bootstrap.Modal.getInstance(o);a&&a.hide(),f(),Swal.fire({toast:!0,position:"top",showConfirmButton:!1,timer:2e3,icon:"success",title:"Discount Applied"})};window.removeDiscount=function(){p={type:"na",name:"",card_no:"",amount:0},f()};window.getCartTotals=function(){let e=l.reduce((c,d)=>{let E=d.price*d.qty;const x=d.pricing_tiers||d.pricingTiers||[];return x.length>0&&(E=C.MultiBuy(parseFloat(d.price),d.qty,x)),c+E},0),t=0,n=0,o=0,a=0,i=0;const r=u.taxType.toLowerCase()==="inclusive";return u.birEnabled===1?p.type==="senior"||p.type==="pwd"?(r?o=e/1.12:o=e,a=o*.2,i=o-a,n=0,t=0):(r?(i=e,t=e/1.12,n=e-t,o=0):(t=e,n=e*.12,i=e+n,o=0),a=0):i=e,{rawTotal:e,vatableSales:t,vatAmount:n,vatExemptSales:o,totalDiscount:a,finalTotal:i}};function f(){localStorage.setItem("pos_cart",JSON.stringify(l));let e="";l.length===0?e=`
        <div class="text-center py-5 text-muted empty-cart-msg">
            <i class="fas fa-shopping-basket fa-3x mb-3 opacity-25"></i>
            <p>Your cart is empty</p>
        </div>`:e=l.map((s,r)=>{const c=s.pricing_tiers||s.pricingTiers||[];let d=s.price*s.qty;return c.length>0&&(d=C.MultiBuy(parseFloat(s.price),s.qty,c)),`
        <div class="d-flex align-items-center justify-content-between p-2 mb-2 bg-white rounded-3 shadow-sm product-card-wrapper">
            <div class="d-flex align-items-center flex-grow-1" style="overflow:hidden;">
                <div class="rounded-3 d-flex align-items-center justify-content-center flex-shrink-0 me-3 bg-light" style="width: 50px; height: 50px;">
                    ${s.image?`<img src="/storage/${s.image}" class="w-100 h-100 rounded-3 object-fit-cover" loading="lazy">`:'<i class="fas fa-box text-muted opacity-50"></i>'}
                </div>
                <div class="d-flex flex-column" style="min-width:0;">
                    <span class="fw-bold text-dark text-truncate" style="font-size:0.9rem;">${s.name}</span>
                    <small class="text-muted">₱${parseFloat(s.price).toFixed(2)} × ${s.qty}</small>
                </div>
            </div>
            <div class="text-end me-3">
                <div class="text-primary small fw-bold">₱${d.toFixed(2)}</div>
                ${c.length>0&&d<s.price*s.qty?'<small class="text-danger fw-bold" style="font-size:0.7rem;">(Promo Applied)</small>':""}
            </div>
            <div class="d-flex align-items-center bg-light rounded-pill border p-1">
                <button class="btn btn-sm btn-link text-dark fw-bold p-0 d-flex align-items-center justify-content-center" style="width: 28px; height: 28px; text-decoration:none;" onclick="modifyQty(${r}, -1)">−</button>
                <span class="fw-bold text-dark text-center" style="width: 24px; font-size: 0.9rem;">${s.qty}</span>
                <button class="btn btn-sm btn-link text-dark fw-bold p-0 d-flex align-items-center justify-content-center" style="width: 28px; height: 28px; text-decoration:none;" onclick="modifyQty(${r}, 1)">+</button>
            </div>
            <button class="btn btn-link text-danger p-0 ms-2" onclick="removeItem(${r})"><i class="fas fa-trash-alt"></i></button>
        </div>`}).join(""),document.querySelectorAll("#cart-items, #cart-items-desktop").forEach(s=>s.innerHTML=e);const t=getCartTotals();p.amount=t.totalDiscount;const n=document.querySelectorAll(".tax-row");if(u.birEnabled===1){n.forEach(d=>{d.classList.remove("d-none"),d.classList.add("d-flex"),d.style.removeProperty("display")});const s=document.getElementById("vatable-sales-display"),r=document.getElementById("vat-exempt-display"),c=document.querySelectorAll(".tax-display");s&&(s.innerText=t.vatableSales.toFixed(2)),r&&(r.innerText=t.vatExemptSales.toFixed(2)),c.forEach(d=>d.innerText=t.vatAmount.toFixed(2))}else n.forEach(s=>{s.classList.remove("d-flex"),s.classList.add("d-none")});document.querySelectorAll(".subtotal-display").forEach(s=>s.innerText=t.rawTotal.toFixed(2)),document.querySelectorAll(".total-amount-display, #mobile-total-display, #modal-total, #total-amount-display-mobile").forEach(s=>s.innerText=t.finalTotal.toFixed(2)),document.getElementById("mobile-cart-count")&&(document.getElementById("mobile-cart-count").innerText=l.length);const o=document.querySelectorAll("#discount-row, #discount-row-mobile"),a=document.getElementById("btn-add-discount"),i=document.getElementById("btn-remove-discount");p.type!=="na"?(o.forEach(s=>{s.style.setProperty("display","flex","important");const r=s.querySelector("#discount-label")||s.querySelector("#discount-label-mobile"),c=s.querySelector("#discount-amount-display")||s.querySelector("#discount-amount-display-mobile");r&&(r.innerText=p.type.toUpperCase()+" 20% (VAT Exempt)"),c&&(c.innerText=t.totalDiscount.toFixed(2))}),a&&a.classList.add("d-none"),i&&i.classList.remove("d-none")):(o.forEach(s=>s.style.setProperty("display","none","important")),a&&a.classList.remove("d-none"),i&&i.classList.add("d-none"))}window.filterCategory=function(e,t){t&&(document.querySelectorAll(".category-btn").forEach(s=>s.classList.remove("active")),t.classList.add("active"),Array.from(document.querySelectorAll(".category-btn")).filter(s=>s.innerText.trim()===t.innerText.trim()).forEach(s=>s.classList.add("active")));const n=(document.getElementById("product-search-desktop")?.value||document.getElementById("product-search-mobile")?.value||"").toLowerCase();let o=!1;document.querySelectorAll(".product-card-wrapper").forEach(i=>{const s=i.dataset.name,r=i.dataset.sku?i.dataset.sku.toString().toLowerCase():"",c=i.dataset.category,d=e==="all"||c===e,E=!n||s.includes(n)||r.includes(n);d&&E?(i.style.display="block",o=!0):i.style.display="none"});const a=document.getElementById("no-results");a&&(a.className=o?"d-none":"d-block text-center py-5")};function L(){["product-search-desktop","product-search-mobile"].forEach(e=>{const t=document.getElementById(e);t&&t.addEventListener("keyup",function(){filterCategory("all",document.querySelector(".category-btn"))})})}window.bindSearchEvents=L;document.addEventListener("DOMContentLoaded",()=>{L(),f()});window.openCustomerModal=function(){new bootstrap.Modal(document.getElementById("customerSelectionModal")).show(),setTimeout(()=>document.getElementById("customer-modal-search").focus(),500)};window.selectCustomer=function(e,t,n){m={id:e,balance:Number(n),points:0},document.querySelectorAll(".selected-customer-name").forEach(c=>c.innerText=t),document.querySelectorAll(".customer-id-input").forEach(c=>c.value=e);const o=document.getElementById("customer-id"),a=document.getElementById("customer-id-mobile");o&&(o.value=e),a&&(a.value=e),document.querySelectorAll(".header-check").forEach(c=>c.classList.add("d-none"));const i=document.getElementById(`check-${e}`);i&&i.classList.remove("d-none");const s=document.getElementById("customerSelectionModal"),r=bootstrap.Modal.getInstance(s);r&&r.hide()};document.getElementById("customer-modal-search")?.addEventListener("keyup",function(){const e=this.value.toLowerCase();document.querySelectorAll(".customer-item").forEach(t=>{const n=t.dataset.name.includes(e);t.classList.toggle("d-none",!n),t.classList.toggle("d-flex",n)})});window.openDebtorList=function(){const e=document.getElementById("debtorListModal");e&&bootstrap.Modal.getOrCreateInstance(e).show()};window.filterDebtors=function(){const e=document.getElementById("debtor-search").value.toLowerCase();document.querySelectorAll("#debtor-list tr").forEach(t=>{t.style.display=t.innerText.toLowerCase().includes(e)?"":"none"})};window.openDebtPaymentModal=function(e,t,n){document.getElementById("pay-debt-customer-id").value=e,document.getElementById("pay-debt-name").innerText=t,document.getElementById("pay-debt-balance").innerText=parseFloat(n).toFixed(2),document.getElementById("pay-debt-amount").value="";const o=document.getElementById("debtorListModal");o&&bootstrap.Modal.getInstance(o).hide();const a=document.getElementById("debtPaymentModal");a&&bootstrap.Modal.getOrCreateInstance(a).show(),setTimeout(()=>document.getElementById("pay-debt-amount").focus(),500)};window.processDebtPayment=function(){const e=document.getElementById("pay-debt-customer-id").value,t=parseFloat(document.getElementById("pay-debt-amount").value);if(!t||t<=0)return Swal.fire("Error","Invalid Amount","error");Swal.showLoading(),fetch("/cashier/credit-payment",{method:"POST",headers:{"Content-Type":"application/json","X-CSRF-TOKEN":u.csrfToken},body:JSON.stringify({customer_id:e,amount:t})}).then(n=>n.json()).then(n=>{n.success?Swal.fire("Success","Payment Recorded","success").then(()=>location.reload()):Swal.fire("Error",n.message,"error")}).catch(n=>Swal.fire("Error","Connection Failed","error"))};window.openPaymentModal=function(){if(l.length===0)return Swal.fire("Empty","Add items first","warning");document.getElementById("amount-paid").value="",document.getElementById("change-display").innerText="₱0.00";const e=document.getElementById("pm-cash"),t=document.getElementById("pm-credit"),n=document.getElementById("pm-digital");e&&(e.disabled=!1),t&&(t.disabled=!1),n&&(n.disabled=!1);let o=m.id;const a=document.getElementById("customer-id-mobile"),i=document.getElementById("customer-id");(a&&a.offsetParent!==null&&a.value==="new"||i&&i.value==="new")&&(o="new",m.id="new"),o==="walk-in"?(t&&(t.disabled=!0),e&&(e.checked=!0)):o==="new"?(e&&(e.disabled=!0),n&&(n.disabled=!0),t&&(t.disabled=!1,t.checked=!0)):e&&(e.checked=!0),toggleFlow(),new bootstrap.Modal(document.getElementById("paymentModal")).show(),setTimeout(()=>document.getElementById("amount-paid").focus(),500)};window.toggleFlow=function(){const e=document.querySelector('input[name="paymethod"]:checked').value;document.getElementById("flow-cash").style.display=e==="cash"?"block":"none",document.getElementById("flow-digital").style.display=e==="digital"?"block":"none",document.getElementById("flow-credit").style.display=e==="credit"?"block":"none";const t=document.getElementById("new-debtor-fields");t&&(t.style.display=m.id==="new"?"block":"none")};window.calculateChange=function(){const t=getCartTotals().finalTotal,o=(parseFloat(document.getElementById("amount-paid").value)||0)-t,a=document.getElementById("change-display");a.innerText=o>=0?"₱"+o.toFixed(2):"Invalid",a.className=o>=0?"fw-bold text-success fs-5":"fw-bold text-danger fs-5"};window.processPayment=function(){if(B)return;const e=document.querySelector('input[name="paymethod"]:checked').value,n=getCartTotals().finalTotal;if(e==="cash"){if((parseFloat(document.getElementById("amount-paid").value)||0)<n)return Swal.fire("Error","Insufficient Cash Payment","error")}else if(e==="credit"&&!document.getElementById("credit-due-date").value)return Swal.fire("Error","Due Date is required","warning");if(m.id==="new"&&!document.getElementById("credit-name").value)return Swal.fire("Error","Customer Name is required","warning");const o={cart:l,total_amount:n,payment_method:e,customer_id:m.id,amount_paid:e==="cash"?document.getElementById("amount-paid").value:0,reference_number:document.getElementById("reference-number")?.value,discount:p.type!=="na"?p:null,credit_details:e==="credit"||m.id==="new"?{name:document.getElementById("credit-name")?.value,due_date:document.getElementById("credit-due-date")?.value,contact:document.getElementById("credit-contact")?.value,address:document.getElementById("credit-address")?.value}:null};if(h){saveToOfflineQueue(o);return}B=!0,Swal.showLoading(),fetch("/cashier/transaction",{method:"POST",headers:{"Content-Type":"application/json",Accept:"application/json","X-CSRF-TOKEN":u.csrfToken},body:JSON.stringify(o)}).then(async a=>{const i=await a.json();if(!a.ok)throw new Error(i.message||"Server Error");return i}).then(a=>{if(a.success){Swal.close(),bootstrap.Modal.getInstance(document.getElementById("paymentModal")).hide(),updateLocalStock(l);const i=parseFloat(o.amount_paid)||0,s=o.payment_method==="cash"?i-o.total_amount:0,r=document.querySelector(`#customer-id option[value="${m.id}"]`)?.text||"Walk-in Customer";showReceiptModal(a,o.total_amount,s,r)}}).catch(a=>{a.message.toLowerCase().includes("fetch")||a.message.toLowerCase().includes("network")?saveToOfflineQueue(o):Swal.fire("Validation Error",a.message,"warning")}).finally(()=>{B=!1})};window.saveToOfflineQueue=function(e){let t=JSON.parse(localStorage.getItem("offline_queue_sales"))||[];e.offline_id=Date.now(),t.push(e),localStorage.setItem("offline_queue_sales",JSON.stringify(t)),l=[],localStorage.removeItem("pos_cart"),f(),bootstrap.Modal.getInstance(document.getElementById("paymentModal")).hide(),Swal.fire("Saved Offline","Transaction stored locally.","info")};window.updateConnectionStatus=function(){h=!navigator.onLine,document.getElementById("connection-status").className=h?"status-offline":"status-online"};window.syncOfflineData=async function(){if(h)return;let e=JSON.parse(localStorage.getItem("offline_queue_sales"))||[];if(e.length===0)return;Swal.mixin({toast:!0,position:"top-end",showConfirmButton:!1,timer:3e3}).fire({icon:"info",title:`Syncing ${e.length} offline records...`});let n=[];for(const o of e)try{if(!(await fetch("/cashier/transaction",{method:"POST",headers:{"Content-Type":"application/json",Accept:"application/json","X-CSRF-TOKEN":u.csrfToken},body:JSON.stringify(o)})).ok)throw new Error("Failed")}catch{n.push(o)}localStorage.setItem("offline_queue_sales",JSON.stringify(n)),n.length===0&&Swal.fire("Synced","All offline transactions uploaded.","success")};window.showReceiptModal=function(e,t,n,o){document.getElementById("receipt-modal-amount").innerText=parseFloat(t).toLocaleString("en-US",{minimumFractionDigits:2}),document.getElementById("receipt-modal-change").innerText=parseFloat(n).toLocaleString("en-US",{minimumFractionDigits:2}),document.getElementById("receipt-modal-customer").innerText=o,document.getElementById("receipt-modal-ref").innerText=e.sale_id||"---";const a=new bootstrap.Modal(document.getElementById("receiptSuccessModal"));a.show(),document.getElementById("btn-receipt-print").onclick=function(){window.open(`/cashier/receipt/${e.sale_id}`,"_blank","width=400,height=600")},document.getElementById("btn-receipt-new").onclick=function(){l=[],localStorage.removeItem("pos_cart"),f(),document.querySelectorAll(".customer-id-input").forEach(i=>i.value="walk-in"),document.querySelectorAll(".selected-customer-name").forEach(i=>i.innerText="Walk-in Customer"),m={id:"walk-in",points:0,balance:0},a.hide()},l=[],localStorage.removeItem("pos_cart"),f()};window.openCameraModal=function(){new bootstrap.Modal(document.getElementById("cameraModal")).show(),startCamera()};window.startCamera=function(){if(g)return;g=new Html5Qrcode("reader");const e={fps:10,qrbox:{width:250,height:250}};g.start({facingMode:"environment"},e,_).catch(t=>{})};function _(e,t){v||(v=!0,playSuccessBeep(),setTimeout(()=>{v=!1},1500),q(e))}window.stopCamera=function(){g&&g.stop().then(()=>{g.clear(),g=null}).catch(e=>console.error(e))};document.getElementById("cameraModal")?.addEventListener("hidden.bs.modal",function(){window.stopCamera()});window.stopCameraAndClose=function(){window.stopCamera()};document.addEventListener("keydown",function(e){e.target.tagName==="INPUT"||e.target.tagName==="TEXTAREA"||(e.key==="Enter"?w.length>2&&(q(w),w=""):e.key.length===1&&(w+=e.key,I&&clearTimeout(I),I=setTimeout(()=>{w=""},100)))});function q(e){if(!e)return;e=e.trim().toLowerCase();const t=b.find(n=>n.sku&&n.sku.toLowerCase()===e||n.id.toString()===e);t?(addToCart(t),playSuccessBeep(),Swal.mixin({toast:!0,position:"top",showConfirmButton:!1,timer:1e3,timerProgressBar:!1}).fire({icon:"success",title:`${t.name} Added`})):(playSuccessBeep(),Swal.fire({toast:!0,position:"top",icon:"error",title:"Item Not Found",timer:1500,showConfirmButton:!1}))}window.requestAdminAuth=async function(e){if(u.userRole==="admin"){e();return}const{value:t}=await Swal.fire({title:"Admin Authorization",input:"password",inputLabel:"Enter Admin/Manager Password",inputPlaceholder:"Password",showCancelButton:!0});t&&(Swal.showLoading(),fetch("/cashier/verify-admin",{method:"POST",headers:{"Content-Type":"application/json","X-CSRF-TOKEN":u.csrfToken},body:JSON.stringify({password:t})}).then(n=>n.json()).then(n=>{n.success?e():Swal.fire("Error","Invalid Password","error")}).catch(n=>Swal.fire("Error","Auth Failed","error")))};window.openReturnModal=function(){const e=document.getElementById("returnModal");e&&bootstrap.Modal.getOrCreateInstance(e).show()};window.searchSaleForReturn=function(){const e=document.getElementById("return-search").value;if(!e)return Swal.fire("Error","Enter Reference No.","warning");Swal.showLoading(),fetch(`/cashier/return/search?query=${e}`,{headers:{Accept:"application/json","Content-Type":"application/json"}}).then(async t=>{if(!t.headers.get("content-type")?.includes("application/json")){const o=await t.text();throw console.error("Non-JSON Response",o),new Error("Server returned non-JSON response")}return t.json()}).then(t=>{if(Swal.close(),t.success){const n=t.sale,o=document.getElementById("return-items-body");o.innerHTML="",document.getElementById("return-sale-id").value=n.id,n.items.forEach(a=>{o.innerHTML+=`
                            <tr>
                                <td>${a.name}</td>
                                <td>${a.sold_qty}</td>
                                <td>₱${a.price}</td>
                                <td>
                                    <select class="form-select form-select-sm mb-2 return-condition" data-id="${a.product_id}">
                                        <option value="good">Good</option>
                                        <option value="damaged">Damaged</option>
                                    </select>
                                    <input type="number" class="form-control form-control-sm return-qty" 
                                           data-id="${a.product_id}" data-price="${a.price}" 
                                           data-max="${a.available_qty}" min="0" max="${a.available_qty}" 
                                           value="0" onchange="calcRefund()">
                                    <small class="text-muted">Max: ${a.available_qty}</small>
                                </td>
                            </tr>`}),document.getElementById("return-results").style.display="block"}else Swal.fire("Error","Sale not found","error")}).catch(t=>Swal.fire("Error","Search failed","error"))};window.calcRefund=function(){let e=0;document.querySelectorAll(".return-qty").forEach(n=>{e+=n.value*n.dataset.price});const t=document.getElementById("total-refund");t&&(t.innerText=e.toFixed(2))};window.submitReturn=function(){const e=document.getElementById("return-sale-id").value,t=[];if(document.querySelectorAll(".return-qty").forEach(n=>{if(n.value>0){const o=n.parentNode.querySelector(".return-condition"),a=o?o.value:"good";t.push({product_id:n.dataset.id,quantity:n.value,condition:a})}}),t.length===0)return Swal.fire("Error","No items selected","warning");Swal.showLoading(),fetch("/cashier/return/process",{method:"POST",headers:{"Content-Type":"application/json",Accept:"application/json","X-CSRF-TOKEN":u.csrfToken},body:JSON.stringify({sale_id:e,items:t})}).then(async n=>{if(!n.headers.get("content-type")?.includes("application/json")){const a=await n.text();throw console.error("Non-JSON Response",a),new Error("Server returned non-JSON response")}return n.json()}).then(n=>{n.success?Swal.fire("Success","Return processed","success").then(()=>location.reload()):Swal.fire("Error",n.message,"error")}).catch(n=>Swal.fire("Error","Proccess failed. Check Console.","error"))};window.generatePaymentLink=function(){const e=parseFloat(document.getElementById("modal-total").innerText.replace(/,/g,""));if(e<=0)return Swal.fire("Error","Invalid Amount","error");const t=document.getElementById("btn-gen-qr");t.disabled=!0,t.innerHTML='<i class="fas fa-spinner fa-spin me-2"></i> Generating...',fetch("/api/paymongo/create-link",{method:"POST",headers:{"Content-Type":"application/json","X-CSRF-TOKEN":u.csrfToken},body:JSON.stringify({amount:e,description:"POS Purchase"})}).then(n=>n.json()).then(n=>{if(n.data&&n.data.attributes){const o=n.data.attributes.checkout_url,a=n.data.id;document.getElementById("paymongo-qr").innerHTML="",new QRCode(document.getElementById("paymongo-qr"),{text:o,width:200,height:200}),document.getElementById("paymongo-controls").style.display="none",document.getElementById("paymongo-qr-area").style.display="block",startPaymentPolling(a)}}).catch(n=>{Swal.fire("Error","Failed to generate QR","error"),t.disabled=!1,t.innerHTML='<i class="fas fa-qrcode me-2"></i> Generate G-Cash QR'})};let S=null;window.startPaymentPolling=function(e){S=setInterval(()=>{fetch(`/api/paymongo/status/${e}`).then(t=>t.json()).then(t=>{(t.attributes.status==="paid"||t.attributes.payments.length>0)&&(clearInterval(S),playSuccessBeep(),document.getElementById("reference-number").value=e,processPayment())}).catch(t=>console.error("Polling error:",t))},3e3)};window.resetPayMongoUI=function(){const e=document.getElementById("btn-gen-qr");e&&(e.disabled=!1,e.innerHTML='<i class="fas fa-qrcode me-2"></i> Generate G-Cash QR');const t=document.getElementById("paymongo-qr-area"),n=document.getElementById("paymongo-controls");t&&(t.style.display="none"),n&&(n.style.display="block"),S&&clearInterval(S)};let k=null;document.addEventListener("DOMContentLoaded",function(){checkRegisterStatus()});window.checkRegisterStatus=function(){if(u.registerLogsEnabled!="1"){document.getElementById("btn-close-register-desktop")?.classList.add("d-none"),document.getElementById("btn-close-register-mobile")?.classList.add("d-none");return}fetch(`/cashier/register/status?t=${Date.now()}`).then(e=>e.json()).then(e=>{u.isRegisterOpen=e.status==="open";const t=document.getElementById("btn-close-register-desktop"),n=document.getElementById("btn-close-register-mobile");if(u.isRegisterOpen){k=e.session.id,t&&t.classList.remove("d-none"),n&&n.classList.remove("d-none");const o=document.getElementById("openRegisterModal"),a=bootstrap.Modal.getInstance(o);a&&a.hide()}else{const o=document.getElementById("openRegisterModal");if(!o)return;if(u.userRole==="admin"){const a=new bootstrap.Modal(o,{backdrop:"static",keyboard:!1}),i=o.querySelector(".modal-header");i&&(i.style.display="block"),a.show()}else{const a=o.querySelector(".modal-body"),i=o.querySelector(".modal-footer"),s=o.querySelector(".modal-header");s&&(s.style.display="none"),i&&(i.style.display="none"),a.innerHTML=`
                            <div class="text-center py-5">
                                <div class="bg-secondary bg-opacity-10 text-secondary rounded-circle d-inline-flex align-items-center justify-content-center mb-4" style="width: 80px; height: 80px;">
                                    <i class="fas fa-store-slash fa-3x opacity-50"></i>
                                </div>
                                <h4 class="fw-bold text-dark">Register is Closed</h4>
                                <p class="text-muted mb-4 px-4">There is no active session.</p>
                                <div class="d-flex justify-content-center gap-2">
                                     <button onclick="window.location.reload()" class="btn btn-primary rounded-pill px-4 fw-bold py-2 shadow-sm"><i class="fas fa-sync-alt me-2"></i> Check Status</button>
                                     <form action="/logout" method="POST" class="d-inline">
                                         <input type="hidden" name="_token" value="${u.csrfToken}">
                                         <button type="submit" class="btn btn-outline-danger rounded-pill px-4 fw-bold shadow-sm py-2"><i class="fas fa-sign-out-alt me-2"></i> Logout</button>
                                     </form>
                                </div>
                            </div>`,new bootstrap.Modal(o,{backdrop:"static",keyboard:!1}).show()}t&&t.classList.add("d-none"),n&&n.classList.add("d-none")}}).catch(e=>console.error("Register Status Check Failed:",e))};window.submitOpenRegister=function(e){e.preventDefault();const t=document.getElementById("opening_float").value;Swal.showLoading(),fetch("/cashier/register/open",{method:"POST",headers:{"Content-Type":"application/json","X-CSRF-TOKEN":u.csrfToken},body:JSON.stringify({opening_amount:t})}).then(n=>n.json()).then(n=>{n.success?Swal.fire({icon:"success",title:"Register Opened",timer:1500,showConfirmButton:!1}).then(()=>location.reload()):Swal.fire("Error",n.message||"Failed","error")})};window.showCloseRegisterModal=function(){if(!k){checkRegisterStatus();return}document.getElementById("close_session_id").value=k;const e=document.getElementById("closeRegisterModal");e&&bootstrap.Modal.getOrCreateInstance(e).show()};window.submitCloseRegister=function(e){e.preventDefault();const t=document.getElementById("closing_amount").value,n=document.getElementById("closing_notes").value,o=document.getElementById("close_session_id").value;if(!t)return Swal.fire("Error","Enter cash count.","warning");Swal.fire({title:"Confirm Closing",html:`Actual Cash: <h2 class="text-danger fw-bold">₱${parseFloat(t).toLocaleString("en-US",{minimumFractionDigits:2})}</h2>`,icon:"warning",showCancelButton:!0,confirmButtonColor:"#dc3545",confirmButtonText:"Yes, Close"}).then(a=>{a.isConfirmed&&(Swal.showLoading(),fetch("/cashier/register/close",{method:"POST",headers:{"Content-Type":"application/json","X-CSRF-TOKEN":u.csrfToken},body:JSON.stringify({session_id:o,closing_amount:t,notes:n})}).then(i=>i.json()).then(i=>{i.success?Swal.fire("Closed","Session closed.","success").then(()=>{i.z_reading&&window.open("/cashier/reading/z","_blank","width=400,height=600"),location.reload()}):Swal.fire("Error",i.message,"error")}))})};window.startLiveStockSync=function(){setInterval(()=>{h||fetch("/cashier/inventory/sync").then(e=>e.json()).then(e=>{e.forEach(t=>{const n=b.find(a=>a.id===t.id);if(n){const a=t.stock!==void 0?parseInt(t.stock):n.current_stock;n.current_stock=a}const o=document.getElementById(`product-stock-${t.id}`);o&&(n&&n.current_stock<=(n.reorder_point||10)?(o.style.display="inline-block",o.innerText=`${n.current_stock} Left`):o.style.display="none")})}).catch(e=>console.warn("Sync skipped"))},1e4)};window.updateLocalStock=function(e){e.forEach(t=>{const n=b.find(o=>o.id===t.id);if(n){n.current_stock-=t.qty,n.current_stock<0&&(n.current_stock=0);const o=document.getElementById(`product-stock-${t.id}`);o&&n.current_stock<=(n.reorder_point||10)&&(o.style.display="inline-block",o.innerText=`${n.current_stock} Left`)}})};document.addEventListener("keydown",function(e){if(e.key==="F2"&&(e.preventDefault(),toggleViewMode()),e.key==="/"&&document.activeElement.tagName!=="INPUT"){e.preventDefault();const t=document.getElementById("product-search-desktop")||document.getElementById("product-search-mobile");t&&t.focus()}e.key==="F4"&&(e.preventDefault(),openPaymentModal()),e.key==="F8"&&(e.preventDefault(),clearCart())});startLiveStockSync();document.addEventListener("DOMContentLoaded",()=>{const e=document.getElementById("btn-receipt-new");e&&e.addEventListener("click",()=>{window.location.reload()}),document.addEventListener("change",function(t){if(t.target&&(t.target.id==="customer-id"||t.target.id==="customer-id-mobile")){const n=t.target,o=n.options[n.selectedIndex],a=n.value;a==="new"?m={id:"new",balance:0,points:0}:a==="walk-in"?m={id:"walk-in",balance:0,points:0}:m={id:a,balance:parseFloat(o.dataset.balance||0),points:parseFloat(o.dataset.points||0)};const i=document.getElementById("customer-id"),s=document.getElementById("customer-id-mobile");n===i&&s?s.value=a:n===s&&i&&(i.value=a)}})});
